{
  "version": "Notebook/1.0",
  "items": [
    {
      "type": 9,
      "content": {
        "version": "KqlParameterItem/1.0",
        "parameters": [
          {
            "id": "1f74ed9a-e3ed-498d-bd5b-f68f3836a117",
            "version": "KqlParameterItem/1.0",
            "name": "Subscription",
            "type": 6,
            "isRequired": true,
            "multiSelect": true,
            "quote": "'",
            "delimiter": ",",
            "typeSettings": {
              "additionalResourceOptions": [
                "value::all"
              ],
              "includeAll": false,
              "showDefault": false
            },
            "timeContext": {
              "durationMs": 86400000
            },
            "defaultValue": "value::all",
            "value": []
          },
          {
            "id": "b616347a-62c0-46e9-9e3a-8c5f6f4e2e6f",
            "version": "KqlParameterItem/1.0",
            "name": "ResourceGroup",
            "label": "Resource Group",
            "type": 2,
            "isRequired": false,
            "multiSelect": true,
            "quote": "'",
            "delimiter": ",",
            "query": "ResourceContainers\n| where type == 'microsoft.resources/subscriptions/resourcegroups'\n| order by name asc\n| project label=name, id=resourceGroup, selected=false",
            "crossComponentResources": [
              "{Subscription}" 
            ],
            "typeSettings": {
              "additionalResourceOptions": [
                "value::all"
              ],
              "showDefault": false
            },
            "timeContext": {
              "durationMs": 86400000
            },
            "defaultValue": "value::all",
            "queryType": 1,
            "resourceType": "microsoft.resourcegraph/resources",
            "value": []
          },
          {
            "id": "c8d7f3e1-9a4b-4f2d-8e5c-6d7a8b9c0d1e",
            "version": "KqlParameterItem/1.0",
            "name": "ResourceType",
            "label": "Resource Type",
            "type": 2,
            "isRequired": false,
            "multiSelect": true,
            "quote": "'",
            "delimiter": ",",
            "query": "Resources\n| distinct type\n| order by type asc\n| project label=type, id=type, selected=false",
            "crossComponentResources": [
              "{Subscription}"
            ],
            "typeSettings": {
              "additionalResourceOptions": [
                "value::all"
              ],
              "showDefault": false
            },
            "timeContext": {
              "durationMs": 86400000
            },
            "defaultValue": "value::all",
            "queryType": 1,
            "resourceType": "microsoft.resourcegraph/resources"
          },
          {
            "id": "f2a1d0b9-1234-5678-90ab-cdef12345678",
            "version": "KqlParameterItem/1.0",
            "name": "ResourceName",
            "label": "Resource Name",
            "type": 1,
            "isRequired": false,
            "quote": "'",
            "value": ""
          }
        ],
        "style": "pills",
        "queryType": 1,
        "resourceType": "microsoft.resourcegraph/resources"
      },
      "name": "parameters - 0"
    },
    {
      "type": 1,
      "content": {
        "json": "# Azure Resource Dependency Map\r\n\r\nComprehensive dependency mapping across Azure resources including VMs, App Services, Databases, Storage, Logic Apps, API Connections, KeyVault, Service Bus, Event Hub, and Cosmos DB.\r\n\r\n---"
      },
      "name": "text - title"
    },
    {
      "type": 11,
      "content": {
        "version": "LinkItem/1.0",
        "style": "tabs",
        "links": [
          {
            "id": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
            "cellValue": "selectedTab",
            "linkTarget": "parameter",
            "linkLabel": "Overview",
            "subTarget": "Overview",
            "style": "link"
          },
          {
            "id": "b2c3d4e5-f6a7-8901-bcde-f12345678901",
            "cellValue": "selectedTab",
            "linkTarget": "parameter",
            "linkLabel": "Virtual Machines",
            "subTarget": "VirtualMachines",
            "style": "link"
          },
          {
            "id": "c3d4e5f6-a7b8-9012-cdef-123456789012",
            "cellValue": "selectedTab",
            "linkTarget": "parameter",
            "linkLabel": "App Services",
            "subTarget": "AppServices",
            "style": "link"
          },
          {
            "id": "d4e5f6a7-b8c9-0123-def1-234567890123",
            "cellValue": "selectedTab",
            "linkTarget": "parameter",
            "linkLabel": "Databases",
            "subTarget": "Databases",
            "style": "link"
          },
          {
            "id": "e5f6a7b8-c9d0-1234-ef12-345678901234",
            "cellValue": "selectedTab",
            "linkTarget": "parameter",
            "linkLabel": "Storage",
            "subTarget": "Storage",
            "style": "link"
          },
          {
            "id": "f6a7b8c9-d0e1-2345-f123-456789012345",
            "cellValue": "selectedTab",
            "linkTarget": "parameter",
            "linkLabel": "Networking",
            "subTarget": "Networking",
            "style": "link"
          },
          {
            "id": "a7b8c9d0-e1f2-3456-1234-567890123456",
            "cellValue": "selectedTab",
            "linkTarget": "parameter",
            "linkLabel": "Integration",
            "subTarget": "Integration",
            "style": "link"
          },
          {
            "id": "b8c9d0e1-f2a3-4567-2345-678901234567",
            "cellValue": "selectedTab",
            "linkTarget": "parameter",
            "linkLabel": "Redis Cache",
            "subTarget": "RedisCache",
            "style": "link"
          },
          {
            "id": "c9d0e1f2-a3b4-5678-3456-789012345678",
            "cellValue": "selectedTab",
            "linkTarget": "parameter",
            "linkLabel": "Containers",
            "subTarget": "Containers",
            "style": "link"
          },
          {
            "id": "e1f2a3b4-c5d6-7890-5678-901234567890",
            "cellValue": "selectedTab",
            "linkTarget": "parameter",
            "linkLabel": "Monitoring",
            "subTarget": "Monitoring",
            "style": "link"
          }
        ]
      },
      "name": "links - tabs"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "## Resource Overview\r\n\r\nSummary of all resources and their dependency counts across selected subscriptions."
            },
            "name": "text - overview header"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "Resources\n| where resourceGroup in ({ResourceGroup}) or '*' in ({ResourceGroup})\n| summarize ResourceCount = count() by type\n| order by ResourceCount desc\n| project ResourceType = type, Count = ResourceCount",
              "size": 0,
              "title": "Resources by Type",
              "queryType": 1,
              "resourceType": "microsoft.resourcegraph/resources",
              "crossComponentResources": [
                "{Subscription}"
              ],
              "visualization": "barchart"
            },
            "name": "query - resources by type"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "selectedTab",
        "comparison": "isEqualTo",
        "value": "Overview"
      },
      "name": "group - overview"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "## Virtual Machine Dependencies\r\n\r\nComprehensive view of VM dependencies including NICs, Disks, Subnets, NSGs, Extensions, and Backup configurations."
            },
            "name": "text - vm header"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "Resources\r\n| where type == \"microsoft.compute/virtualmachines\"\r\n| where resourceGroup in ({ResourceGroup}) or '*' in ({ResourceGroup})\r\n| extend \r\n    NICCount = array_length(properties.networkProfile.networkInterfaces),\r\n    DataDiskCount = array_length(properties.storageProfile.dataDisks),\r\n    HasManagedIdentity = isnotnull(identity.principalId),\r\n    ManagedIdentityPrincipalId = identity.principalId,\r\n    HasAvailabilitySet = isnotnull(properties.availabilitySet),\r\n    AvailabilitySetName = split(properties.availabilitySet.id, '/')[-1],\r\n    HasProximityPlacementGroup = isnotnull(properties.proximityPlacementGroup),\r\n    ProximityPlacementGroupName = split(properties.proximityPlacementGroup.id, '/')[-1],\r\n    BootDiagnostics = properties.diagnosticsProfile.bootDiagnostics.enabled,\r\n    OSDiskName = properties.storageProfile.osDisk.name,\r\n    OSDiskType = properties.storageProfile.osDisk.managedDisk.storageAccountType\r\n| project \r\n    VMName = name,\r\n    ResourceGroup = resourceGroup,\r\n    Location = location,\r\n    VMSize = properties.hardwareProfile.vmSize,\r\n    OSType = properties.storageProfile.osDisk.osType,\r\n    OSDisk = OSDiskName,\r\n    OSDiskType,\r\n    DataDisks = DataDiskCount,\r\n    NetworkInterfaces = NICCount,\r\n    ManagedIdentityId = coalesce(ManagedIdentityPrincipalId, \"N/A\"),\r\n    AvailabilitySet = coalesce(AvailabilitySetName, \"N/A\"),\r\n    ProximityPlacementGroup = coalesce(ProximityPlacementGroupName, \"N/A\"),\r\n    BootDiagnostics = iff(BootDiagnostics == true, \"true\", \"false\"),\r\n    ResourceId = id\r\n| order by tostring(VMName) asc",
              "size": 0,
              "title": "Virtual Machines Overview",
              "queryType": 1,
              "resourceType": "microsoft.resourcegraph/resources",
              "crossComponentResources": [
                "{Subscription}"
              ]
            },
            "name": "query - vms overview"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "Resources\r\n| where type == \"microsoft.compute/virtualmachines\"\r\n| where resourceGroup in ({ResourceGroup}) or '*' in ({ResourceGroup})\r\n| mv-expand nic = properties.networkProfile.networkInterfaces\r\n| extend NICId = tostring(nic.id)\r\n| extend NICName = split(NICId, '/')[-1]\r\n| join kind=leftouter (\r\n    Resources\r\n    | where type == \"microsoft.network/networkinterfaces\"\r\n    | mv-expand ipconfig = properties.ipConfigurations\r\n    | extend \r\n        SubnetId = tostring(ipconfig.properties.subnet.id),\r\n        NSGId = tostring(properties.networkSecurityGroup.id),\r\n        PrivateIP = tostring(ipconfig.properties.privateIPAddress)\r\n    | project NICId = id, SubnetId, NSGId, PrivateIP\r\n) on NICId\r\n| extend \r\n    SubnetName = split(SubnetId, '/')[-1],\r\n    VNetName = split(SubnetId, '/')[-3],\r\n    NSGName = split(NSGId, '/')[-1]\r\n| project \r\n    VMName = name,\r\n    ResourceGroup = resourceGroup,\r\n    NetworkInterface = NICName,\r\n    PrivateIP = coalesce(PrivateIP, \"N/A\"),\r\n    VirtualNetwork = coalesce(VNetName, \"N/A\"),\r\n    Subnet = coalesce(SubnetName, \"N/A\"),\r\n    NetworkSecurityGroup = coalesce(NSGName, \"N/A\")\r\n| order by tostring(VMName) asc",
              "size": 0,
              "title": "VM Network Dependencies",
              "queryType": 1,
              "resourceType": "microsoft.resourcegraph/resources",
              "crossComponentResources": [
                "{Subscription}"
              ]
            },
            "name": "query - vm network deps"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "Resources\r\n| where type == \"microsoft.compute/virtualmachines\"\r\n| where resourceGroup in ({ResourceGroup}) or '*' in ({ResourceGroup})\r\n| extend OSDisk = properties.storageProfile.osDisk.managedDisk.id\r\n| mv-expand DataDisk = properties.storageProfile.dataDisks\r\n| extend DataDiskId = tostring(DataDisk.managedDisk.id)\r\n| extend DiskName = split(coalesce(DataDiskId, OSDisk), '/')[-1]\r\n| extend DiskType = case(\r\n    isnotnull(DataDiskId), \"Data Disk\",\r\n    \"OS Disk\"\r\n)\r\n| project \r\n    VMName = name,\r\n    ResourceGroup = resourceGroup,\r\n    DiskType,\r\n    DiskName,\r\n    DiskSizeGB = toint(coalesce(DataDisk.diskSizeGB, properties.storageProfile.osDisk.diskSizeGB)),\r\n    StorageAccountType = tostring(coalesce(DataDisk.managedDisk.storageAccountType, properties.storageProfile.osDisk.managedDisk.storageAccountType))\r\n| order by tostring(VMName) asc, tostring(DiskType) asc",
              "size": 0,
              "title": "VM Disk Dependencies",
              "queryType": 1,
              "resourceType": "microsoft.resourcegraph/resources",
              "crossComponentResources": [
                "{Subscription}"
              ]
            },
            "name": "query - vm disk deps"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "Resources\r\n| where type == \"microsoft.compute/virtualmachines/extensions\"\r\n| where resourceGroup in ({ResourceGroup}) or '*' in ({ResourceGroup})\r\n| extend VMName = split(id, '/')[-3]\r\n| project \r\n    VMName,\r\n    ResourceGroup = resourceGroup,\r\n    ExtensionName = name,\r\n    Publisher = properties.publisher,\r\n    ExtensionType = properties.type,\r\n    Version = properties.typeHandlerVersion,\r\n    ProvisioningState = properties.provisioningState\r\n| order by tostring(VMName) asc",
              "size": 0,
              "title": "VM Extensions",
              "queryType": 1,
              "resourceType": "microsoft.resourcegraph/resources",
              "crossComponentResources": [
                "{Subscription}"
              ]
            },
            "name": "query - vm extensions"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "selectedTab",
        "comparison": "isEqualTo",
        "value": "VirtualMachines"
      },
      "name": "group - vms"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "## App Service Dependencies\r\n\r\nApp Services, Functions, and their dependencies including Service Plans, VNet Integration, Slots, Certificates, and App Insights."
            },
            "name": "text - app services header"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "Resources\r\n| where type == \"microsoft.web/sites\"\r\n| where resourceGroup in ({ResourceGroup}) or '*' in ({ResourceGroup})\r\n| where kind !contains \"functionapp\"\r\n| where '{ResourceName}' == '' or name contains '{ResourceName}'\r\n| extend SiteId = tolower(tostring(id))\r\n| join kind=leftouter (\r\n    Resources\r\n    | where type == \"microsoft.web/sites/config\" and name endswith \"/web\"\r\n    | extend SiteId = tolower(tostring(substring(id, 0, indexof(id, '/config/'))))\r\n    | extend BackupEnabled = isnotnull(properties.backupSchedule)\r\n    | project SiteId, BackupEnabled\r\n) on SiteId\r\n| join kind=leftouter (\r\n    Resources\r\n    | where type == \"microsoft.servicelinker/linkers\"\r\n    | extend SiteId = tolower(tostring(substring(id, 0, indexof(id, '/providers/Microsoft.ServiceLinker'))))\r\n    | extend TargetService = tostring(properties.targetService.type)\r\n    | summarize ServiceConnections = make_list(TargetService) by SiteId\r\n) on SiteId\r\n| join kind=leftouter (\r\n    Resources\r\n    | where type == \"microsoft.web/sites/config\" and name endswith \"/authsettingsV2\"\r\n    | extend SiteId = tolower(tostring(substring(id, 0, indexof(id, '/config/'))))\r\n    | extend IdentityProviders = properties.identityProviders\r\n    | extend ProviderList = bag_keys(IdentityProviders)\r\n    | project SiteId, ProviderList\r\n) on SiteId\r\n| extend \r\n    AppServicePlan = split(properties.serverFarmId, '/')[-1],\r\n    Kind = kind,\r\n    HasVNetIntegration = isnotnull(properties.virtualNetworkSubnetId),\r\n    VNetName = split(properties.virtualNetworkSubnetId, '/')[-3],\r\n    HasManagedIdentity = isnotnull(identity.principalId),\r\n    ManagedIdentityPrincipalId = identity.principalId,\r\n    HTTPSOnly = properties.httpsOnly,\r\n    State = properties.state,\r\n    DefaultHostName = properties.defaultHostName,\r\n    HasBackup = iff(BackupEnabled == true, \"Yes\", \"No\"),\r\n    ServiceConnector = iff(isnotnull(ServiceConnections) and array_length(ServiceConnections) > 0, strcat_array(ServiceConnections, \", \"), \"N/A\"),\r\n    ['Identity Provider'] = iff(isnotnull(ProviderList) and array_length(ProviderList) > 0, strcat_array(ProviderList, \", \"), \"N/A\")\r\n| project \r\n    AppName = name,\r\n    ResourceGroup = resourceGroup,\r\n    Location = location,\r\n    Kind,\r\n    AppServicePlan,\r\n    State,\r\n    HTTPSOnly,\r\n    HasBackup,\r\n    ServiceConnector,\r\n    ['Identity Provider'],\r\n    VNetIntegrated = iff(HasVNetIntegration, \"Yes\", \"No\"),\r\n    VNetName = coalesce(VNetName, \"N/A\"),\r\n    ManagedIdentityId = coalesce(ManagedIdentityPrincipalId, \"N/A\"),\r\n    DefaultHostName,\r\n    ResourceId = id\r\n| order by tostring(AppName) asc",
              "size": 0,
              "title": "App Services (Web Apps)",
              "queryType": 1,
              "resourceType": "microsoft.resourcegraph/resources",
              "crossComponentResources": [
                "{Subscription}"
              ]
            },
            "name": "query - app services overview"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "Resources\r\n| where type == \"microsoft.web/sites\"\r\n| where resourceGroup in ({ResourceGroup}) or '*' in ({ResourceGroup})\r\n| where kind contains \"functionapp\"\r\n| where '{ResourceName}' == '' or name contains '{ResourceName}'\r\n| extend SiteId = tolower(tostring(id))\r\n| join kind=leftouter (\r\n    Resources\r\n    | where type == \"microsoft.web/sites/config\" and name endswith \"/web\"\r\n    | extend SiteId = tolower(tostring(substring(id, 0, indexof(id, '/config/'))))\r\n    | extend BackupEnabled = isnotnull(properties.backupSchedule)\r\n    | project SiteId, BackupEnabled\r\n) on SiteId\r\n| join kind=leftouter (\r\n    Resources\r\n    | where type == \"microsoft.servicelinker/linkers\"\r\n    | extend SiteId = tolower(tostring(substring(id, 0, indexof(id, '/providers/Microsoft.ServiceLinker'))))\r\n    | extend TargetService = tostring(properties.targetService.type)\r\n    | summarize ServiceConnections = make_list(TargetService) by SiteId\r\n) on SiteId\r\n| join kind=leftouter (\r\n    Resources\r\n    | where type == \"microsoft.web/sites/config\" and name endswith \"/authsettingsV2\"\r\n    | extend SiteId = tolower(tostring(substring(id, 0, indexof(id, '/config/'))))\r\n    | extend IdentityProviders = properties.identityProviders\r\n    | extend ProviderList = bag_keys(IdentityProviders)\r\n    | project SiteId, ProviderList\r\n) on SiteId\r\n| extend \r\n    AppServicePlan = split(properties.serverFarmId, '/')[-1],\r\n    Kind = kind,\r\n    HasVNetIntegration = isnotnull(properties.virtualNetworkSubnetId),\r\n    VNetName = split(properties.virtualNetworkSubnetId, '/')[-3],\r\n    HasManagedIdentity = isnotnull(identity.principalId),\r\n    ManagedIdentityPrincipalId = identity.principalId,\r\n    HTTPSOnly = properties.httpsOnly,\r\n    State = properties.state,\r\n    DefaultHostName = properties.defaultHostName,\r\n    Runtime = properties.siteConfig.linuxFxVersion,\r\n    HasBackup = iff(BackupEnabled == true, \"Yes\", \"No\"),\r\n    ServiceConnector = iff(isnotnull(ServiceConnections) and array_length(ServiceConnections) > 0, strcat_array(ServiceConnections, \", \"), \"N/A\"),\r\n    ['Identity Provider'] = iff(isnotnull(ProviderList) and array_length(ProviderList) > 0, strcat_array(ProviderList, \", \"), \"N/A\")\r\n| project \r\n    FunctionAppName = name,\r\n    ResourceGroup = resourceGroup,\r\n    Location = location,\r\n    Kind,\r\n    Runtime,\r\n    AppServicePlan,\r\n    State,\r\n    HTTPSOnly,\r\n    HasBackup,\r\n    ServiceConnector,\r\n    ['Identity Provider'],\r\n    VNetIntegrated = iff(HasVNetIntegration, \"Yes\", \"No\"),\r\n    VNetName = coalesce(VNetName, \"N/A\"),\r\n    ManagedIdentityId = coalesce(ManagedIdentityPrincipalId, \"N/A\"),\r\n    DefaultHostName,\r\n    ResourceId = id\r\n| order by tostring(FunctionAppName) asc",
              "size": 0,
              "title": "Function Apps",
              "queryType": 1,
              "resourceType": "microsoft.resourcegraph/resources",
              "crossComponentResources": [
                "{Subscription}"
              ]
            },
            "name": "query - function apps overview"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "Resources\r\n| where type == \"microsoft.web/sites\"\r\n| where resourceGroup in ({ResourceGroup}) or '*' in ({ResourceGroup})\r\n| where '{ResourceName}' == '' or name contains '{ResourceName}'\r\n| extend AppServicePlanId = tolower(tostring(properties.serverFarmId))\r\n| join kind=leftouter (\r\n    Resources\r\n    | where type == \"microsoft.web/serverfarms\"\r\n    | project \r\n        AppServicePlanId = tolower(tostring(id)),\r\n        PlanName = name,\r\n        PlanResourceGroup = resourceGroup,\r\n        PlanSKU = sku.name,\r\n        PlanTier = sku.tier,\r\n        PlanCapacity = sku.capacity\r\n) on AppServicePlanId\r\n| join kind=leftouter (\r\n    Resources\r\n    | where type == \"microsoft.insights/autoscalesettings\"\r\n    | extend AppServicePlanId = tolower(tostring(properties.targetResourceId))\r\n    | summarize AutoscaleCount = count() by AppServicePlanId\r\n) on AppServicePlanId\r\n| extend HasAutoscale = iff(AutoscaleCount > 0, \"Yes\", \"No\")\r\n| project \r\n    AppServicePlan = coalesce(PlanName, split(tostring(properties.serverFarmId), '/')[-1]),\r\n    PlanResourceGroup = coalesce(PlanResourceGroup, split(tostring(properties.serverFarmId), '/')[-5]),\r\n    AppName = name,\r\n    ResourceGroup = resourceGroup,\r\n    PlanSKU = coalesce(PlanSKU, \"N/A\"),\r\n    PlanTier = coalesce(PlanTier, \"N/A\"),\r\n    PlanCapacity = coalesce(PlanCapacity, \"N/A\"),\r\n    HasAutoscale\r\n| order by tostring(AppServicePlan) asc, tostring(AppName) asc",
              "size": 0,
              "title": "App Service Plan Dependencies",
              "queryType": 1,
              "resourceType": "microsoft.resourcegraph/resources",
              "crossComponentResources": [
                "{Subscription}"
              ]
            },
            "name": "query - app service plans"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "Resources\r\n| where type == \"microsoft.web/sites\"\r\n| where resourceGroup in ({ResourceGroup}) or '*' in ({ResourceGroup})\r\n| where isnotnull(properties.virtualNetworkSubnetId)\r\n| where '{ResourceName}' == '' or name contains '{ResourceName}'\r\n| extend \r\n    SubnetId = tostring(properties.virtualNetworkSubnetId),\r\n    HasManagedIdentity = isnotnull(identity.principalId),\r\n    VNetRouteAllEnabled = properties.vnetRouteAllEnabled\r\n| extend \r\n    SubnetName = split(SubnetId, '/')[-1],\r\n    VNetName = split(SubnetId, '/')[-3],\r\n    VNetResourceGroup = split(SubnetId, '/')[-7]\r\n| project \r\n    AppName = name,\r\n    ResourceGroup = resourceGroup,\r\n    Location = location,\r\n    Kind = kind,\r\n    VirtualNetwork = VNetName,\r\n    VNetResourceGroup,\r\n    Subnet = SubnetName,\r\n    RouteAllTraffic = VNetRouteAllEnabled,\r\n    State = properties.state,\r\n    DefaultHostName = properties.defaultHostName,\r\n    ResourceId = id\r\n| order by tostring(AppName) asc",
              "size": 0,
              "title": "App Services with VNet Integration",
              "queryType": 1,
              "resourceType": "microsoft.resourcegraph/resources",
              "crossComponentResources": [
                "{Subscription}"
              ]
            },
            "name": "query - app services vnet"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "Resources\r\n| where type == \"microsoft.web/sites/slots\"\r\n| where resourceGroup in ({ResourceGroup}) or '*' in ({ResourceGroup})\r\n| extend AppName = split(id, '/')[-3]\r\n| where '{ResourceName}' == '' or name contains '{ResourceName}' or AppName contains '{ResourceName}'\r\n| project \r\n    AppName,\r\n    SlotName = name,\r\n    ResourceGroup = resourceGroup,\r\n    State = properties.state,\r\n    DefaultHostName = properties.defaultHostName\r\n| order by tostring(AppName) asc, SlotName asc",
              "size": 0,
              "title": "Deployment Slots",
              "queryType": 1,
              "resourceType": "microsoft.resourcegraph/resources",
              "crossComponentResources": [
                "{Subscription}"
              ]
            },
            "name": "query - deployment slots"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "Resources\r\n| where type == \"microsoft.web/certificates\"\r\n| where resourceGroup in ({ResourceGroup}) or '*' in ({ResourceGroup})\r\n| extend \r\n    ExpirationDate = todatetime(properties.expirationDate),\r\n    DaysUntilExpiry = datetime_diff('day', todatetime(properties.expirationDate), now()),\r\n    CertExpired = iff(todatetime(properties.expirationDate) < now(), \"Yes\", \"No\")\r\n| project \r\n    CertificateName = name,\r\n    ResourceGroup = resourceGroup,\r\n    ExpirationDate,\r\n    DaysUntilExpiry,\r\n    CertExpired\r\n| order by DaysUntilExpiry asc",
              "size": 0,
              "title": "SSL Certificates",
              "queryType": 1,
              "resourceType": "microsoft.resourcegraph/resources",
              "crossComponentResources": [
                "{Subscription}"
              ]
            },
            "name": "query - certificates"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "selectedTab",
        "comparison": "isEqualTo",
        "value": "AppServices"
      },
      "name": "group - app services"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "## Database Dependencies\r\n\r\nSQL Servers, Databases, Elastic Pools, MySQL, PostgreSQL, Cosmos DB, and their network/security configurations."
            },
            "name": "text - databases header"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "Resources\r\n| where type == \"microsoft.sql/servers\"\r\n| where resourceGroup in ({ResourceGroup}) or '*' in ({ResourceGroup})\r\n| where '{ResourceName}' == '' or name contains '{ResourceName}'\r\n| extend ServerId = tolower(id)\r\n| join kind=leftouter (\r\n    Resources\r\n    | where type == \"microsoft.sql/servers/databases\"\r\n    | where name != \"master\"\r\n    | extend ServerId = tolower(substring(id, 0, indexof(id, '/databases/')))\r\n    | summarize DatabaseCount = count() by ServerId\r\n) on ServerId\r\n| join kind=leftouter (\r\n    Resources\r\n    | where type == \"microsoft.sql/servers/elasticpools\"\r\n    | extend ServerId = tolower(substring(id, 0, indexof(id, '/elasticpools/')))\r\n    | summarize ElasticPoolCount = count() by ServerId\r\n) on ServerId\r\n| join kind=leftouter (\r\n    Resources\r\n    | where type == \"microsoft.sql/servers/failovergroups\"\r\n    | extend ServerId = tolower(substring(id, 0, indexof(id, '/failovergroups/')))\r\n    | summarize FailoverGroupCount = count() by ServerId\r\n) on ServerId\r\n| extend \r\n    HasManagedIdentity = isnotnull(identity.principalId),\r\n    ManagedIdentityPrincipalId = identity.principalId,\r\n    PublicNetworkAccess = properties.publicNetworkAccess,\r\n    MinTLSVersion = properties.minimalTlsVersion,\r\n    HasPrivateEndpoint = iff(isnotnull(properties.privateEndpointConnections) and array_length(properties.privateEndpointConnections) > 0, \"Yes\", \"No\"),\r\n    HasBackups = iff(DatabaseCount > 0, \"Yes\", \"No\"),\r\n    HasFailoverGroups = iff(FailoverGroupCount > 0, \"Yes\", \"No\")\r\n| project \r\n    ServerName = name,\r\n    ResourceGroup = resourceGroup,\r\n    Location = location,\r\n    FullyQualifiedDomainName = properties.fullyQualifiedDomainName,\r\n    Version = properties.version,\r\n    DatabaseCount = coalesce(DatabaseCount, 0),\r\n    ElasticPoolCount = coalesce(ElasticPoolCount, 0),\r\n    HasBackups,\r\n    HasFailoverGroups,\r\n    HasPrivateEndpoint,\r\n    ManagedIdentityId = coalesce(ManagedIdentityPrincipalId, \"N/A\"),\r\n    PublicNetworkAccess,\r\n    MinTLSVersion,\r\n    ResourceId = id\r\n| order by tostring(ServerName) asc",
              "size": 0,
              "title": "SQL Servers",
              "queryType": 1,
              "resourceType": "microsoft.resourcegraph/resources",
              "crossComponentResources": [
                "{Subscription}"
              ]
            },
            "name": "query - sql servers"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "Resources\r\n| where type == \"microsoft.sql/servers/databases\"\r\n| where resourceGroup in ({ResourceGroup}) or '*' in ({ResourceGroup})\r\n| where name != \"master\"\r\n| extend \r\n    ServerName = tostring(split(id, '/')[-3]),\r\n    DatabaseId = tolower(id)\r\n| where '{ResourceName}' == '' or name contains '{ResourceName}' or ServerName contains '{ResourceName}'\r\n| join kind=leftouter (\r\n    Resources\r\n    | where type == \"microsoft.sql/servers/databases/syncgroups\"\r\n    | extend DatabaseId = tolower(substring(id, 0, indexof(id, '/syncGroups/')))\r\n    | summarize SyncGroupCount = count() by DatabaseId\r\n) on DatabaseId\r\n| extend \r\n    MaxSizeGB = toint(properties.maxSizeBytes) / 1024 / 1024 / 1024,\r\n    HasReplicas = iff(isnotnull(properties.secondaryType) or (isnotnull(properties.failoverGroupId)), \"Yes\", \"No\"),\r\n    ReplicaType = case(\r\n        properties.secondaryType == \"Geo\", \"Geo-Replica\",\r\n        properties.secondaryType == \"Named\", \"Named-Replica\",\r\n        isnotnull(properties.failoverGroupId), \"Failover Group\",\r\n        \"Primary\"\r\n    ),\r\n    HasSyncGroups = iff(SyncGroupCount > 0, \"Yes\", \"No\")\r\n| project \r\n    DatabaseName = name,\r\n    ServerName,\r\n    ResourceGroup = resourceGroup,\r\n    Location = location,\r\n    SKU = sku.name,\r\n    Tier = sku.tier,\r\n    MaxSizeGB,\r\n    Status = properties.status,\r\n    ReplicaType,\r\n    HasReplicas,\r\n    HasSyncGroups,\r\n    ElasticPoolId = properties.elasticPoolId,\r\n    ResourceId = id\r\n| order by tostring(DatabaseName) asc, tostring(ServerName) asc",
              "size": 0,
              "title": "SQL Databases",
              "queryType": 1,
              "resourceType": "microsoft.resourcegraph/resources",
              "crossComponentResources": [
                "{Subscription}"
              ]
            },
            "name": "query - sql databases"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "Resources\r\n| where type == \"microsoft.sql/servers/virtualnetworkrules\"\r\n| where resourceGroup in ({ResourceGroup}) or '*' in ({ResourceGroup})\r\n| extend \r\n    ServerName = split(id, '/')[-3],\r\n    SubnetId = tostring(properties.virtualNetworkSubnetId)\r\n| extend \r\n    SubnetName = split(SubnetId, '/')[-1],\r\n    VNetName = split(SubnetId, '/')[-3]\r\n| project \r\n    ServerName,\r\n    RuleName = name,\r\n    ResourceGroup = resourceGroup,\r\n    VirtualNetwork = VNetName,\r\n    Subnet = SubnetName,\r\n    State = properties.state\r\n| order by tostring(ServerName) asc",
              "size": 0,
              "title": "SQL Server VNet Rules",
              "queryType": 1,
              "resourceType": "microsoft.resourcegraph/resources",
              "crossComponentResources": [
                "{Subscription}"
              ]
            },
            "name": "query - sql vnet rules"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "Resources\r\n| where type in (\"microsoft.dbformysql/servers\", \"microsoft.dbformysql/flexibleservers\", \"microsoft.dbforpostgresql/servers\", \"microsoft.dbforpostgresql/flexibleservers\")\r\n| where resourceGroup in ({ResourceGroup}) or '*' in ({ResourceGroup})\r\n| extend \r\n    DatabaseType = case(\r\n        type contains \"mysql\", \"MySQL\",\r\n        type contains \"postgresql\", \"PostgreSQL\",\r\n        \"Unknown\"\r\n    ),\r\n    ServerType = case(\r\n        type contains \"flexible\", \"Flexible Server\",\r\n        \"Single Server\"\r\n    )\r\n| project \r\n    ServerName = name,\r\n    ResourceGroup = resourceGroup,\r\n    Location = location,\r\n    DatabaseType,\r\n    ServerType,\r\n    Version = properties.version,\r\n    FullyQualifiedDomainName = properties.fullyQualifiedDomainName,\r\n    PublicNetworkAccess = properties.publicNetworkAccess,\r\n    ResourceId = id\r\n| order by tostring(DatabaseType) asc, ServerName asc",
              "size": 0,
              "title": "MySQL & PostgreSQL Servers",
              "queryType": 1,
              "resourceType": "microsoft.resourcegraph/resources",
              "crossComponentResources": [
                "{Subscription}"
              ]
            },
            "name": "query - mysql postgres"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "Resources\r\n| where type == \"microsoft.documentdb/databaseaccounts\"\r\n| where resourceGroup in ({ResourceGroup}) or '*' in ({ResourceGroup})\r\n| extend \r\n    HasManagedIdentity = isnotnull(identity.principalId),\r\n    ManagedIdentityPrincipalId = tostring(identity.principalId),\r\n    PublicNetworkAccess = properties.publicNetworkAccess,\r\n    DatabaseAccountOfferType = properties.databaseAccountOfferType\r\n| mv-expand Capability = properties.capabilities\r\n| summarize Capabilities = make_list(Capability.name) by \r\n    name, resourceGroup, location, HasManagedIdentity, ManagedIdentityPrincipalId, tostring(PublicNetworkAccess), tostring(DatabaseAccountOfferType), id\r\n| project \r\n    AccountName = name,\r\n    ResourceGroup = resourceGroup,\r\n    Location = location,\r\n    OfferType = DatabaseAccountOfferType,\r\n    Capabilities = strcat_array(Capabilities, \", \"),\r\n    ManagedIdentityId = coalesce(ManagedIdentityPrincipalId, \"N/A\"),\r\n    PublicNetworkAccess,\r\n    ResourceId = id\r\n| order by tostring(AccountName) asc",
              "size": 0,
              "title": "Cosmos DB Accounts",
              "queryType": 1,
              "resourceType": "microsoft.resourcegraph/resources",
              "crossComponentResources": [
                "{Subscription}"
              ]
            },
            "name": "query - cosmos db"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "selectedTab",
        "comparison": "isEqualTo",
        "value": "Databases"
      },
      "name": "group - databases"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "## Storage Dependencies\r\n\r\nStorage Accounts, Encryption Keys, File Shares, Blob Containers, and network configurations."
            },
            "name": "text - storage header"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "Resources\r\n| where type == \"microsoft.storage/storageaccounts\"\r\n| where resourceGroup in ({ResourceGroup}) or '*' in ({ResourceGroup})\r\n| extend \r\n    HasManagedIdentity = isnotnull(identity.principalId),\r\n    ManagedIdentityPrincipalId = identity.principalId,\r\n    PublicNetworkAccess = properties.publicNetworkAccess,\r\n    AllowBlobPublicAccess = properties.allowBlobPublicAccess,\r\n    MinTLSVersion = properties.minimumTlsVersion,\r\n    SupportsHttpsTrafficOnly = properties.supportsHttpsTrafficOnly,\r\n    PrimaryLocation = properties.primaryLocation,\r\n    HasCustomerManagedKey = isnotnull(properties.encryption.keyvaultproperties),\r\n    KeyVaultName = split(properties.encryption.keyvaultproperties.keyvaulturi, '/')[-1]\r\n| project \r\n    StorageAccountName = name,\r\n    ResourceGroup = resourceGroup,\r\n    Location = location,\r\n    SKU = sku.name,\r\n    Kind = kind,\r\n    PrimaryLocation,\r\n    HTTPSOnly = SupportsHttpsTrafficOnly,\r\n    MinTLSVersion,\r\n    PublicBlobAccess = AllowBlobPublicAccess,\r\n    PublicNetworkAccess,\r\n    ManagedIdentity = iff(HasManagedIdentity, \"Yes\", \"No\"),\r\n    ManagedIdentityId = ManagedIdentityPrincipalId,\r\n    CustomerManagedKey = iff(HasCustomerManagedKey, \"Yes\", \"No\"),\r\n    KeyVaultName,\r\n    ResourceId = id\r\n| order by tostring(StorageAccountName) asc",
              "size": 0,
              "title": "Storage Accounts",
              "queryType": 1,
              "resourceType": "microsoft.resourcegraph/resources",
              "crossComponentResources": [
                "{Subscription}"
              ]
            },
            "name": "query - storage accounts"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "Resources\r\n| where type == \"microsoft.storage/storageaccounts\"\r\n| where resourceGroup in ({ResourceGroup}) or '*' in ({ResourceGroup})\r\n| where isnotnull(properties.encryption.keyvaultproperties)\r\n| extend \r\n    KeyVaultUri = properties.encryption.keyvaultproperties.keyvaulturi,\r\n    KeyName = properties.encryption.keyvaultproperties.keyname,\r\n    KeyVersion = properties.encryption.keyvaultproperties.keyversion\r\n| project \r\n    StorageAccountName = name,\r\n    ResourceGroup = resourceGroup,\r\n    KeyVaultUri,\r\n    KeyName,\r\n    KeyVersion\r\n| order by tostring(StorageAccountName) asc",
              "size": 0,
              "title": "Storage Accounts with Customer-Managed Keys",
              "queryType": 1,
              "resourceType": "microsoft.resourcegraph/resources",
              "crossComponentResources": [
                "{Subscription}"
              ]
            },
            "name": "query - storage cmk"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "Resources\r\n| where type == 'microsoft.storage/storageaccounts'\r\n| where resourceGroup in ({ResourceGroup}) or '*' in ({ResourceGroup})\r\n| where isnotnull(properties.networkAcls)\r\n| where isnotnull(properties.networkAcls.virtualNetworkRules)\r\n| mv-expand VNetRule = properties.networkAcls.virtualNetworkRules\r\n| where isnotnull(VNetRule)\r\n| extend SubnetId = tostring(VNetRule.id)\r\n| extend \r\n    SubnetName = split(SubnetId, '/')[-1],\r\n    VNetName = split(SubnetId, '/')[-3],\r\n    DefaultAction = tostring(properties.networkAcls.defaultAction),\r\n    Bypass = tostring(properties.networkAcls.bypass),\r\n    RuleAction = tostring(VNetRule.action)\r\n| project \r\n    StorageAccountName = name,\r\n    ResourceGroup = resourceGroup,\r\n    DefaultAction,\r\n    Bypass,\r\n    VirtualNetwork = VNetName,\r\n    Subnet = SubnetName,\r\n    Action = RuleAction\r\n| order by tostring(StorageAccountName) asc",
              "size": 0,
              "title": "Storage Account Network Rules",
              "queryType": 1,
              "resourceType": "microsoft.resourcegraph/resources",
              "crossComponentResources": [
                "{Subscription}"
              ]
            },
            "name": "query - storage network rules"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "selectedTab",
        "comparison": "isEqualTo",
        "value": "Storage"
      },
      "name": "group - storage"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "## Networking\r\n\r\nVirtual Networks, Subnets, NSGs, Private Endpoints, Load Balancers, Application Gateways, Front Door, Traffic Manager, and Azure Firewall."
            },
            "name": "text - networking header"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "Resources\r\n| where type == \"microsoft.network/virtualnetworks\"\r\n| where resourceGroup in ({ResourceGroup}) or '*' in ({ResourceGroup})\r\n| extend \r\n    AddressSpace = properties.addressSpace.addressPrefixes,\r\n    SubnetCount = array_length(properties.subnets)\r\n| project \r\n    VNetName = name,\r\n    ResourceGroup = resourceGroup,\r\n    Location = location,\r\n    AddressSpace = strcat_array(AddressSpace, \", \"),\r\n    SubnetCount,\r\n    ResourceId = id\r\n| order by tostring(VNetName) asc",
              "size": 0,
              "title": "Virtual Networks",
              "queryType": 1,
              "resourceType": "microsoft.resourcegraph/resources",
              "crossComponentResources": [
                "{Subscription}"
              ]
            },
            "name": "query - vnets"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "Resources\r\n| where type == \"microsoft.network/virtualnetworks\"\r\n| where resourceGroup in ({ResourceGroup}) or '*' in ({ResourceGroup})\r\n| mv-expand Subnet = properties.subnets\r\n| extend \r\n    SubnetName = Subnet.name,\r\n    AddressPrefix = Subnet.properties.addressPrefix,\r\n    NSGId = tostring(Subnet.properties.networkSecurityGroup.id),\r\n    HasDelegation = isnotnull(Subnet.properties.delegations) and array_length(Subnet.properties.delegations) > 0\r\n| extend \r\n    NSGName = split(NSGId, '/')[-1]\r\n| project \r\n    VNetName = name,\r\n    ResourceGroup = resourceGroup,\r\n    SubnetName,\r\n    AddressPrefix,\r\n    NetworkSecurityGroup = NSGName,\r\n    HasDelegation\r\n| order by tostring(VNetName) asc, tostring(SubnetName) asc",
              "size": 0,
              "title": "Subnets",
              "queryType": 1,
              "resourceType": "microsoft.resourcegraph/resources",
              "crossComponentResources": [
                "{Subscription}"
              ]
            },
            "name": "query - subnets"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "Resources\r\n| where type == \"microsoft.network/networksecuritygroups\"\r\n| where resourceGroup in ({ResourceGroup}) or '*' in ({ResourceGroup})\r\n| extend \r\n    SecurityRuleCount = array_length(properties.securityRules),\r\n    DefaultSecurityRuleCount = array_length(properties.defaultSecurityRules),\r\n    AttachedSubnets = array_length(properties.subnets),\r\n    AttachedNICs = array_length(properties.networkInterfaces)\r\n| project \r\n    NSGName = name,\r\n    ResourceGroup = resourceGroup,\r\n    Location = location,\r\n    CustomRules = SecurityRuleCount,\r\n    DefaultRules = DefaultSecurityRuleCount,\r\n    AttachedSubnets,\r\n    AttachedNICs,\r\n    ResourceId = id\r\n| order by tostring(NSGName) asc",
              "size": 0,
              "title": "Network Security Groups",
              "queryType": 1,
              "resourceType": "microsoft.resourcegraph/resources",
              "crossComponentResources": [
                "{Subscription}"
              ]
            },
            "name": "query - nsgs"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "Resources\r\n| where type == \"microsoft.network/privateendpoints\"\r\n| where resourceGroup in ({ResourceGroup}) or '*' in ({ResourceGroup})\r\n| extend \r\n    SubnetId = tostring(properties.subnet.id)\r\n| extend \r\n    SubnetName = split(SubnetId, '/')[-1],\r\n    VNetName = split(SubnetId, '/')[-3]\r\n| mv-expand Connection = properties.privateLinkServiceConnections\r\n| extend ConnectedResourceId = tostring(Connection.properties.privateLinkServiceId)\r\n| extend \r\n    ConnectedResourceName = split(ConnectedResourceId, '/')[-1],\r\n    ConnectedResourceType = substring(ConnectedResourceId, indexof(ConnectedResourceId, 'providers/') + 10, indexof(substring(ConnectedResourceId, indexof(ConnectedResourceId, 'providers/') + 10), '/')) \r\n| extend IsDatabase = ConnectedResourceType in (\r\n    \"Microsoft.Sql\",\r\n    \"Microsoft.DBforMySQL\",\r\n    \"Microsoft.DBforPostgreSQL\",\r\n    \"Microsoft.DocumentDB\"\r\n)\r\n| extend DatabaseType = case(\r\n    ConnectedResourceType == \"Microsoft.Sql\", \"SQL Server\",\r\n    ConnectedResourceType == \"Microsoft.DBforMySQL\", \"MySQL\",\r\n    ConnectedResourceType == \"Microsoft.DBforPostgreSQL\", \"PostgreSQL\",\r\n    ConnectedResourceType == \"Microsoft.DocumentDB\", \"Cosmos DB\",\r\n    \"N/A\"\r\n)\r\n| project \r\n    PrivateEndpointName = name,\r\n    ResourceGroup = resourceGroup,\r\n    Location = location,\r\n    VirtualNetwork = VNetName,\r\n    Subnet = SubnetName,\r\n    ConnectedResource = ConnectedResourceName,\r\n    ConnectedResourceType,\r\n    DatabaseType,\r\n    ConnectionState = Connection.properties.privateLinkServiceConnectionState.status\r\n| order by tostring(PrivateEndpointName) asc",
              "size": 0,
              "title": "Private Endpoints",
              "queryType": 1,
              "resourceType": "microsoft.resourcegraph/resources",
              "crossComponentResources": [
                "{Subscription}"
              ]
            },
            "name": "query - private endpoints"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "Resources\r\n| where type == \"microsoft.network/applicationgateways\"\r\n| where resourceGroup in ({ResourceGroup}) or '*' in ({ResourceGroup})\r\n| extend \r\n    SKU = sku.name,\r\n    Tier = sku.tier,\r\n    Capacity = sku.capacity,\r\n    HasManagedIdentity = isnotnull(identity.principalId),\r\n    ManagedIdentityPrincipalId = tostring(identity.principalId),\r\n    BackendPoolCount = array_length(properties.backendAddressPools),\r\n    ListenerCount = array_length(properties.httpListeners),\r\n    RoutingRuleCount = array_length(properties.requestRoutingRules),\r\n    OperationalState = properties.operationalState,\r\n    ProvisioningState = properties.provisioningState\r\n| project \r\n    AppGatewayName = name,\r\n    ResourceGroup = resourceGroup,\r\n    Location = location,\r\n    SKU,\r\n    Tier,\r\n    Capacity,\r\n    BackendPools = BackendPoolCount,\r\n    Listeners = ListenerCount,\r\n    RoutingRules = RoutingRuleCount,\r\n    WAFEnabled = properties.webApplicationFirewallConfiguration.enabled,\r\n    OperationalState,\r\n    ManagedIdentityId = coalesce(ManagedIdentityPrincipalId, \"N/A\"),\r\n    ProvisioningState,\r\n    ResourceId = id\r\n| order by tostring(AppGatewayName) asc",
              "size": 0,
              "title": "Application Gateways",
              "queryType": 1,
              "resourceType": "microsoft.resourcegraph/resources",
              "crossComponentResources": [
                "{Subscription}"
              ]
            },
            "name": "query - app gateways"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "Resources\r\n| where type == \"microsoft.network/loadbalancers\"\r\n| where resourceGroup in ({ResourceGroup}) or '*' in ({ResourceGroup})\r\n| extend \r\n    SKU = sku.name,\r\n    FrontendIPCount = array_length(properties.frontendIPConfigurations),\r\n    BackendPools = properties.backendAddressPools,\r\n    LoadBalancingRuleCount = array_length(properties.loadBalancingRules),\r\n    ProvisioningState = properties.provisioningState\r\n| mv-expand BackendPool = BackendPools\r\n| extend BackendConfigs = BackendPool.properties.backendIPConfigurations\r\n| mv-expand BackendConfig = BackendConfigs\r\n| extend BackendResourceId = tostring(BackendConfig.id)\r\n| extend BackendResourceName = split(BackendResourceId, '/')[-3]\r\n| summarize \r\n    BackendResources = strcat_array(make_list(BackendResourceName), ', '),\r\n    FrontendIPCount = any(FrontendIPCount),\r\n    LoadBalancingRuleCount = any(LoadBalancingRuleCount),\r\n    ProvisioningState = any(ProvisioningState),\r\n    SKU = any(SKU),\r\n    Location = any(location),\r\n    ResourceGroup = any(resourceGroup),\r\n    ResourceId = any(id)\r\n    by LoadBalancerName = name\r\n| project \r\n    LoadBalancerName,\r\n    ResourceGroup,\r\n    Location,\r\n    SKU,\r\n    FrontendIPCount,\r\n    BackendResources = coalesce(BackendResources, \"None\"),\r\n    LoadBalancingRuleCount,\r\n    ProvisioningState,\r\n    ResourceId\r\n| order by tostring(LoadBalancerName) asc",
              "size": 0,
              "title": "Load Balancers",
              "queryType": 1,
              "resourceType": "microsoft.resourcegraph/resources",
              "crossComponentResources": [
                "{Subscription}"
              ]
            },
            "name": "query - load balancers"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "Resources\r\n| where type == \"microsoft.network/frontdoors\"\r\n| where resourceGroup in ({ResourceGroup}) or '*' in ({ResourceGroup})\r\n| extend \r\n    FrontendEndpointCount = array_length(properties.frontendEndpoints),\r\n    BackendPoolCount = array_length(properties.backendPools),\r\n    RoutingRuleCount = array_length(properties.routingRules),\r\n    EnabledState = properties.enabledState,\r\n    ProvisioningState = properties.provisioningState\r\n| project \r\n    FrontDoorName = name,\r\n    ResourceGroup = resourceGroup,\r\n    Location = location,\r\n    FrontendEndpointCount,\r\n    BackendPoolCount,\r\n    RoutingRuleCount,\r\n    EnabledState,\r\n    ProvisioningState,\r\n    ResourceId = id\r\n| order by tostring(FrontDoorName) asc",
              "size": 0,
              "title": "Azure Front Door",
              "queryType": 1,
              "resourceType": "microsoft.resourcegraph/resources",
              "crossComponentResources": [
                "{Subscription}"
              ]
            },
            "name": "query - front door"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "Resources\r\n| where type == \"microsoft.network/trafficmanagerprofiles\"\r\n| where resourceGroup in ({ResourceGroup}) or '*' in ({ResourceGroup})\r\n| extend \r\n    TrafficRoutingMethod = properties.trafficRoutingMethod,\r\n    DNSConfig = properties.dnsConfig,\r\n    MonitorConfig = properties.monitorConfig,\r\n    ProfileStatus = properties.profileStatus\r\n| project \r\n    ProfileName = name,\r\n    ResourceGroup = resourceGroup,\r\n    Location = location,\r\n    TrafficRoutingMethod,\r\n    DNSTTLSeconds = DNSConfig.ttl,\r\n    MonitorProtocol = MonitorConfig.protocol,\r\n    MonitorPort = MonitorConfig.port,\r\n    ProfileStatus,\r\n    ResourceId = id\r\n| order by tostring(ProfileName) asc",
              "size": 0,
              "title": "Traffic Manager Profiles",
              "queryType": 1,
              "resourceType": "microsoft.resourcegraph/resources",
              "crossComponentResources": [
                "{Subscription}"
              ]
            },
            "name": "query - traffic manager"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "Resources\r\n| where type == \"microsoft.network/azurefirewalls\"\r\n| where resourceGroup in ({ResourceGroup}) or '*' in ({ResourceGroup})\r\n| extend \r\n    SKU = sku.name,\r\n    Tier = sku.tier,\r\n    ThreatIntelMode = properties.threatIntelMode,\r\n    ProvisioningState = properties.provisioningState\r\n| project \r\n    FirewallName = name,\r\n    ResourceGroup = resourceGroup,\r\n    Location = location,\r\n    SKU,\r\n    Tier,\r\n    ThreatIntelMode,\r\n    ProvisioningState,\r\n    ResourceId = id\r\n| order by tostring(FirewallName) asc",
              "size": 0,
              "title": "Azure Firewalls",
              "queryType": 1,
              "resourceType": "microsoft.resourcegraph/resources",
              "crossComponentResources": [
                "{Subscription}"
              ]
            },
            "name": "query - firewalls"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "Resources\r\n| where type == \"microsoft.network/publicipaddresses\"\r\n| where resourceGroup in ({ResourceGroup}) or '*' in ({ResourceGroup})\r\n| extend \r\n    SKU = sku.name,\r\n    PublicIPAllocationMethod = properties.publicIPAllocationMethod,\r\n    IPAddress = properties.ipAddress,\r\n    AssociatedResource = tostring(properties.ipConfiguration.id)\r\n| extend \r\n    AssociatedResourceName = split(AssociatedResource, '/')[-3]\r\n| project \r\n    PublicIPName = name,\r\n    ResourceGroup = resourceGroup,\r\n    Location = location,\r\n    SKU,\r\n    AllocationMethod = PublicIPAllocationMethod,\r\n    IPAddress = coalesce(IPAddress, \"Not Assigned\"),\r\n    AssociatedTo = coalesce(AssociatedResourceName, \"Unassociated\"),\r\n    ResourceId = id\r\n| order by tostring(PublicIPName) asc",
              "size": 0,
              "title": "Public IP Addresses",
              "queryType": 1,
              "resourceType": "microsoft.resourcegraph/resources",
              "crossComponentResources": [
                "{Subscription}"
              ]
            },
            "name": "query - public ips"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "selectedTab",
        "comparison": "isEqualTo",
        "value": "Networking"
      },
      "name": "group - networking"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "## Integration Services\r\n\r\nLogic Apps, API Connections, Service Bus, Event Hub, Data Factory, Key Vault, and API Management."
            },
            "name": "text - integration header"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "Resources\r\n| where type == \"microsoft.logic/workflows\"\r\n| where resourceGroup in ({ResourceGroup}) or '*' in ({ResourceGroup})\r\n| extend \r\n    State = properties.state,\r\n    HasManagedIdentity = isnotnull(identity.principalId),\r\n    ManagedIdentityPrincipalId = identity.principalId\r\n| project \r\n    LogicAppName = name,\r\n    ResourceGroup = resourceGroup,\r\n    Location = location,\r\n    State,\r\n    ManagedIdentityId = coalesce(ManagedIdentityPrincipalId, \"N/A\"),\r\n    ResourceId = id\r\n| order by tostring(LogicAppName) asc",
              "size": 0,
              "title": "Logic Apps",
              "queryType": 1,
              "resourceType": "microsoft.resourcegraph/resources",
              "crossComponentResources": [
                "{Subscription}"
              ]
            },
            "name": "query - logic apps"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "Resources\r\n| where type == \"microsoft.web/connections\"\r\n| where resourceGroup in ({ResourceGroup}) or '*' in ({ResourceGroup})\r\n| extend \r\n    APIType = split(properties.api.id, '/')[-1],\r\n    DisplayName = properties.displayName,\r\n    Status = properties.statuses[0].status\r\n| project \r\n    ConnectionName = name,\r\n    ResourceGroup = resourceGroup,\r\n    Location = location,\r\n    APIType = coalesce(APIType, \"N/A\"),\r\n    DisplayName = coalesce(DisplayName, \"N/A\"),\r\n    Status = coalesce(Status, \"N/A\"),\r\n    ResourceId = id\r\n| order by tostring(ConnectionName) asc",
              "size": 0,
              "title": "API Connections",
              "queryType": 1,
              "resourceType": "microsoft.resourcegraph/resources",
              "crossComponentResources": [
                "{Subscription}"
              ]
            },
            "name": "query - api connections"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "Resources\r\n| where type == \"microsoft.servicebus/namespaces\"\r\n| where resourceGroup in ({ResourceGroup}) or '*' in ({ResourceGroup})\r\n| extend \r\n    SKU = sku.name,\r\n    HasManagedIdentity = isnotnull(identity.principalId),\r\n    ManagedIdentityPrincipalId = identity.principalId,\r\n    Status = properties.status\r\n| project \r\n    NamespaceName = name,\r\n    ResourceGroup = resourceGroup,\r\n    Location = location,\r\n    SKU,\r\n    Status = coalesce(Status, \"N/A\"),\r\n    ManagedIdentityId = coalesce(ManagedIdentityPrincipalId, \"N/A\"),\r\n    ResourceId = id\r\n| order by tostring(NamespaceName) asc",
              "size": 0,
              "title": "Service Bus Namespaces",
              "queryType": 1,
              "resourceType": "microsoft.resourcegraph/resources",
              "crossComponentResources": [
                "{Subscription}"
              ]
            },
            "name": "query - service bus"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "Resources\r\n| where type == \"microsoft.eventhub/namespaces\"\r\n| where resourceGroup in ({ResourceGroup}) or '*' in ({ResourceGroup})\r\n| extend \r\n    SKU = sku.name,\r\n    HasManagedIdentity = isnotnull(identity.principalId),\r\n    ManagedIdentityPrincipalId = identity.principalId,\r\n    Status = properties.status\r\n| project \r\n    NamespaceName = name,\r\n    ResourceGroup = resourceGroup,\r\n    Location = location,\r\n    SKU,\r\n    Status = coalesce(Status, \"N/A\"),\r\n    ManagedIdentityId = coalesce(ManagedIdentityPrincipalId, \"N/A\"),\r\n    ResourceId = id\r\n| order by tostring(NamespaceName) asc",
              "size": 0,
              "title": "Event Hub Namespaces",
              "queryType": 1,
              "resourceType": "microsoft.resourcegraph/resources",
              "crossComponentResources": [
                "{Subscription}"
              ]
            },
            "name": "query - event hub"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "Resources\r\n| where type == \"microsoft.keyvault/vaults\"\r\n| where resourceGroup in ({ResourceGroup}) or '*' in ({ResourceGroup})\r\n| extend \r\n    SKU = sku.name,\r\n    EnabledForDeployment = properties.enabledForDeployment,\r\n    EnabledForDiskEncryption = properties.enabledForDiskEncryption,\r\n    EnabledForTemplateDeployment = properties.enabledForTemplateDeployment,\r\n    SoftDeleteEnabled = properties.enableSoftDelete,\r\n    PurgeProtectionEnabled = properties.enablePurgeProtection,\r\n    PublicNetworkAccess = properties.publicNetworkAccess\r\n| project \r\n    VaultName = name,\r\n    ResourceGroup = resourceGroup,\r\n    Location = location,\r\n    SKU,\r\n    VaultUri = properties.vaultUri,\r\n    SoftDeleteEnabled = coalesce(SoftDeleteEnabled, \"N/A\"),\r\n    PurgeProtectionEnabled = coalesce(PurgeProtectionEnabled, \"N/A\"),\r\n    PublicNetworkAccess = coalesce(PublicNetworkAccess, \"N/A\"),\r\n    EnabledForDeployment = coalesce(EnabledForDeployment, \"N/A\"),\r\n    EnabledForDiskEncryption = coalesce(EnabledForDiskEncryption, \"N/A\"),\r\n    ResourceId = id\r\n| order by tostring(VaultName) asc",
              "size": 0,
              "title": "Key Vaults",
              "queryType": 1,
              "resourceType": "microsoft.resourcegraph/resources",
              "crossComponentResources": [
                "{Subscription}"
              ]
            },
            "name": "query - key vaults"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "Resources\r\n| where type == \"microsoft.datafactory/factories\"\r\n| where resourceGroup in ({ResourceGroup}) or '*' in ({ResourceGroup})\r\n| extend \r\n    HasManagedIdentity = isnotnull(identity.principalId),\r\n    ManagedIdentityPrincipalId = identity.principalId,\r\n    HasManagedVNet = isnotnull(properties.managedVirtualNetwork),\r\n    Version = properties.version\r\n| project \r\n    DataFactoryName = name,\r\n    ResourceGroup = resourceGroup,\r\n    Location = location,\r\n    Version = coalesce(Version, \"N/A\"),\r\n    ManagedIdentityId = coalesce(ManagedIdentityPrincipalId, \"N/A\"),\r\n    ManagedVNet = iff(HasManagedVNet, \"Yes\", \"No\"),\r\n    ResourceId = id\r\n| order by tostring(DataFactoryName) asc",
              "size": 0,
              "title": "Data Factories",
              "queryType": 1,
              "resourceType": "microsoft.resourcegraph/resources",
              "crossComponentResources": [
                "{Subscription}"
              ]
            },
            "name": "query - data factory"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "Resources\r\n| where type == \"microsoft.apimanagement/service\"\r\n| where resourceGroup in ({ResourceGroup}) or '*' in ({ResourceGroup})\r\n| extend \r\n    SKU = sku.name,\r\n    Capacity = sku.capacity,\r\n    HasManagedIdentity = isnotnull(identity.principalId),\r\n    ManagedIdentityPrincipalId = identity.principalId,\r\n    PublisherName = properties.publisherName,\r\n    PublisherEmail = properties.publisherEmail,\r\n    GatewayUrl = properties.gatewayUrl\r\n| project \r\n    APIManagementName = name,\r\n    ResourceGroup = resourceGroup,\r\n    Location = location,\r\n    SKU,\r\n    Capacity,\r\n    PublisherName = coalesce(PublisherName, \"N/A\"),\r\n    PublisherEmail = coalesce(PublisherEmail, \"N/A\"),\r\n    GatewayUrl = coalesce(GatewayUrl, \"N/A\"),\r\n    ManagedIdentityId = coalesce(ManagedIdentityPrincipalId, \"N/A\"),\r\n    ResourceId = id\r\n| order by tostring(APIManagementName) asc",
              "size": 0,
              "title": "API Management Services",
              "queryType": 1,
              "resourceType": "microsoft.resourcegraph/resources",
              "crossComponentResources": [
                "{Subscription}"
              ]
            },
            "name": "query - api management"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "selectedTab",
        "comparison": "isEqualTo",
        "value": "Integration"
      },
      "name": "group - integration"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "## Redis Cache Dependencies\r\n\r\nAzure Cache for Redis and Azure Managed Redis instances with their configurations, network rules, and private endpoints."
            },
            "name": "text - redis header"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "Resources\r\n| where type == \"microsoft.cache/redis\"\r\n| where resourceGroup in ({ResourceGroup}) or '*' in ({ResourceGroup})\r\n| extend \r\n    SKU = sku.name,\r\n    Capacity = sku.capacity,\r\n    Family = sku.family,\r\n    HasManagedIdentity = isnotnull(identity.principalId),\r\n    ManagedIdentityPrincipalId = identity.principalId,\r\n    RedisVersion = properties.redisVersion,\r\n    EnableNonSslPort = properties.enableNonSslPort,\r\n    MinTLSVersion = properties.minimumTlsVersion,\r\n    PublicNetworkAccess = properties.publicNetworkAccess,\r\n    ProvisioningState = properties.provisioningState\r\n| project \r\n    RedisCacheName = name,\r\n    ResourceGroup = resourceGroup,\r\n    Location = location,\r\n    SKU,\r\n    Capacity,\r\n    Family,\r\n    RedisVersion,\r\n    HostName = properties.hostName,\r\n    SSLPort = properties.sslPort,\r\n    Port = properties.port,\r\n    EnableNonSslPort,\r\n    MinTLSVersion,\r\n    PublicNetworkAccess,\r\n    ManagedIdentityId = coalesce(ManagedIdentityPrincipalId, \"N/A\"),\r\n    ProvisioningState,\r\n    ResourceId = id\r\n| order by tostring(RedisCacheName) asc",
              "size": 0,
              "title": "Redis Cache Instances",
              "queryType": 1,
              "resourceType": "microsoft.resourcegraph/resources",
              "crossComponentResources": [
                "{Subscription}"
              ]
            },
            "name": "query - redis instances"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "Resources\r\n| where type == \"microsoft.cache/redis\"\r\n| where resourceGroup in ({ResourceGroup}) or '*' in ({ResourceGroup})\r\n| where isnotnull(properties.subnetId)\r\n| extend \r\n    SubnetId = tostring(properties.subnetId)\r\n| extend \r\n    SubnetName = split(SubnetId, '/')[-1],\r\n    VNetName = split(SubnetId, '/')[-3],\r\n    VNetResourceGroup = split(SubnetId, '/')[-7]\r\n| project \r\n    RedisCacheName = name,\r\n    ResourceGroup = resourceGroup,\r\n    Location = location,\r\n    SKU = sku.name,\r\n    VirtualNetwork = VNetName,\r\n    VNetResourceGroup,\r\n    Subnet = SubnetName,\r\n    StaticIP = properties.staticIP\r\n| order by tostring(RedisCacheName) asc",
              "size": 0,
              "title": "Redis Cache with VNet Integration",
              "queryType": 1,
              "resourceType": "microsoft.resourcegraph/resources",
              "crossComponentResources": [
                "{Subscription}"
              ]
            },
            "name": "query - redis vnet"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "Resources\r\n| where type == \"microsoft.cache/redis/privateendpointconnections\"\r\n| where resourceGroup in ({ResourceGroup}) or '*' in ({ResourceGroup})\r\n| extend \r\n    RedisCacheName = split(id, '/')[-3],\r\n    PrivateEndpointId = tostring(properties.privateEndpoint.id),\r\n    ConnectionState = properties.privateLinkServiceConnectionState.status,\r\n    ConnectionDescription = properties.privateLinkServiceConnectionState.description\r\n| extend \r\n    PrivateEndpointName = split(PrivateEndpointId, '/')[-1]\r\n| project \r\n    RedisCacheName,\r\n    ResourceGroup = resourceGroup,\r\n    PrivateEndpointConnectionName = name,\r\n    PrivateEndpoint = PrivateEndpointName,\r\n    ConnectionState,\r\n    ConnectionDescription,\r\n    ProvisioningState = properties.provisioningState\r\n| order by tostring(RedisCacheName) asc",
              "size": 0,
              "title": "Redis Cache Private Endpoint Connections",
              "queryType": 1,
              "resourceType": "microsoft.resourcegraph/resources",
              "crossComponentResources": [
                "{Subscription}"
              ]
            },
            "name": "query - redis private endpoints"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "Resources\r\n| where type == \"microsoft.cache/redis/linkedservers\"\r\n| where resourceGroup in ({ResourceGroup}) or '*' in ({ResourceGroup})\r\n| extend \r\n    PrimaryCacheName = split(id, '/')[-3],\r\n    LinkedServerResourceId = tostring(properties.linkedRedisCacheId)\r\n| extend \r\n    LinkedServerName = split(LinkedServerResourceId, '/')[-1],\r\n    LinkedServerResourceGroup = split(LinkedServerResourceId, '/')[-5]\r\n| project \r\n    PrimaryCacheName,\r\n    ResourceGroup = resourceGroup,\r\n    LinkedServerName,\r\n    LinkedServerResourceGroup,\r\n    LinkedServerLocation = properties.linkedRedisCacheLocation,\r\n    ServerRole = properties.serverRole,\r\n    ProvisioningState = properties.provisioningState\r\n| order by tostring(PrimaryCacheName) asc",
              "size": 0,
              "title": "Redis Cache Geo-Replication (Linked Servers)",
              "queryType": 1,
              "resourceType": "microsoft.resourcegraph/resources",
              "crossComponentResources": [
                "{Subscription}"
              ]
            },
            "name": "query - redis linked servers"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "Resources\r\n| where type == \"microsoft.cache/redisenterprise\"\r\n| where resourceGroup in ({ResourceGroup}) or '*' in ({ResourceGroup})\r\n| extend \r\n    SKU = sku.name,\r\n    Capacity = sku.capacity,\r\n    HasManagedIdentity = isnotnull(identity.principalId),\r\n    ManagedIdentityPrincipalId = identity.principalId,\r\n    MinTLSVersion = properties.minimumTlsVersion\r\n| project \r\n    RedisEnterpriseName = name,\r\n    ResourceGroup = resourceGroup,\r\n    Location = location,\r\n    SKU,\r\n    Capacity,\r\n    HostName = properties.hostName,\r\n    MinTLSVersion,\r\n    ManagedIdentityId = coalesce(ManagedIdentityPrincipalId, \"N/A\"),\r\n    ProvisioningState = properties.provisioningState,\r\n    ResourceState = properties.resourceState,\r\n    ResourceId = id\r\n| order by tostring(RedisEnterpriseName) asc",
              "size": 0,
              "title": "Redis Enterprise Instances",
              "queryType": 1,
              "resourceType": "microsoft.resourcegraph/resources",
              "crossComponentResources": [
                "{Subscription}"
              ]
            },
            "name": "query - redis enterprise"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "selectedTab",
        "comparison": "isEqualTo",
        "value": "RedisCache"
      },
      "name": "group - redis"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "## Container Services\r\n\r\nAzure Container Instances, Container Registries, and Azure Kubernetes Service resources with their dependencies."
            },
            "name": "text - containers header"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "Resources\r\n| where type == \"microsoft.containerregistry/registries\"\r\n| where resourceGroup in ({ResourceGroup}) or '*' in ({ResourceGroup})\r\n| extend \r\n    SKU = sku.name,\r\n    HasManagedIdentity = isnotnull(identity.principalId),\r\n    ManagedIdentityPrincipalId = identity.principalId,\r\n    AdminUserEnabled = properties.adminUserEnabled,\r\n    PublicNetworkAccess = properties.publicNetworkAccess,\r\n    ZoneRedundancy = properties.zoneRedundancy\r\n| project \r\n    RegistryName = name,\r\n    ResourceGroup = resourceGroup,\r\n    Location = location,\r\n    SKU,\r\n    LoginServer = properties.loginServer,\r\n    AdminUserEnabled,\r\n    PublicNetworkAccess,\r\n    ZoneRedundancy,\r\n    ManagedIdentityId = coalesce(ManagedIdentityPrincipalId, \"N/A\"),\r\n    ResourceId = id\r\n| order by tostring(RegistryName) asc",
              "size": 0,
              "title": "Container Registries",
              "queryType": 1,
              "resourceType": "microsoft.resourcegraph/resources",
              "crossComponentResources": [
                "{Subscription}"
              ]
            },
            "name": "query - container registries"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "Resources\r\n| where type == \"microsoft.containerinstance/containergroups\"\r\n| where resourceGroup in ({ResourceGroup}) or '*' in ({ResourceGroup})\r\n| extend \r\n    OSType = properties.osType,\r\n    ProvisioningState = properties.provisioningState,\r\n    RestartPolicy = properties.restartPolicy,\r\n    SubnetId = tostring(properties.subnetIds[0].id)\r\n| extend \r\n    VNetName = split(SubnetId, '/')[-3],\r\n    SubnetName = split(SubnetId, '/')[-1]\r\n| project \r\n    ContainerGroupName = name,\r\n    ResourceGroup = resourceGroup,\r\n    Location = location,\r\n    OSType,\r\n    RestartPolicy,\r\n    IPAddress = properties.ipAddress.ip,\r\n    VirtualNetwork = coalesce(VNetName, \"N/A\"),\r\n    Subnet = coalesce(SubnetName, \"N/A\"),\r\n    ProvisioningState,\r\n    ResourceId = id\r\n| order by tostring(ContainerGroupName) asc",
              "size": 0,
              "title": "Container Instances",
              "queryType": 1,
              "resourceType": "microsoft.resourcegraph/resources",
              "crossComponentResources": [
                "{Subscription}"
              ]
            },
            "name": "query - container instances"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "Resources\r\n| where type == \"microsoft.containerservice/managedclusters\"\r\n| where resourceGroup in ({ResourceGroup}) or '*' in ({ResourceGroup})\r\n| extend \r\n    KubernetesVersion = properties.kubernetesVersion,\r\n    HasManagedIdentity = isnotnull(identity.principalId),\r\n    ManagedIdentityPrincipalId = tostring(identity.principalId),\r\n    NetworkPlugin = properties.networkProfile.networkPlugin,\r\n    NetworkPolicy = properties.networkProfile.networkPolicy,\r\n    DNSPrefix = properties.dnsPrefix,\r\n    FQDN = properties.fqdn,\r\n    NodeResourceGroup = properties.nodeResourceGroup,\r\n    EnableRBAC = properties.enableRBAC,\r\n    ProvisioningState = properties.provisioningState\r\n| project \r\n    ClusterName = name,\r\n    ResourceGroup = resourceGroup,\r\n    Location = location,\r\n    KubernetesVersion,\r\n    NetworkPlugin,\r\n    NetworkPolicy,\r\n    FQDN,\r\n    NodeResourceGroup,\r\n    EnableRBAC,\r\n    ManagedIdentityId = coalesce(ManagedIdentityPrincipalId, \"N/A\"),\r\n    ProvisioningState,\r\n    ResourceId = id\r\n| order by tostring(ClusterName) asc",
              "size": 0,
              "title": "Azure Kubernetes Service (AKS) Clusters",
              "queryType": 1,
              "resourceType": "microsoft.resourcegraph/resources",
              "crossComponentResources": [
                "{Subscription}"
              ]
            },
            "name": "query - aks clusters"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "Resources\r\n| where type == \"microsoft.containerservice/managedclusters\"\r\n| where resourceGroup in ({ResourceGroup}) or '*' in ({ResourceGroup})\r\n| mv-expand AgentPool = properties.agentPoolProfiles\r\n| project \r\n    ClusterName = name,\r\n    ResourceGroup = resourceGroup,\r\n    NodePoolName = AgentPool.name,\r\n    VMSize = AgentPool.vmSize,\r\n    Count = AgentPool.count,\r\n    Mode = AgentPool.mode,\r\n    OSType = AgentPool.osType,\r\n    MaxPods = AgentPool.maxPods,\r\n    ProvisioningState = AgentPool.provisioningState\r\n| order by tostring(ClusterName) asc, tostring(NodePoolName) asc",
              "size": 0,
              "title": "AKS Node Pools",
              "queryType": 1,
              "resourceType": "microsoft.resourcegraph/resources",
              "crossComponentResources": [
                "{Subscription}"
              ]
            },
            "name": "query - aks node pools"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "selectedTab",
        "comparison": "isEqualTo",
        "value": "Containers"
      },
      "name": "group - containers"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "## Monitoring & Diagnostics\r\n\r\nLog Analytics Workspaces, Application Insights, and diagnostic settings showing where resources send their logs."
            },
            "name": "text - monitoring header"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "Resources\r\n| where type == \"microsoft.operationalinsights/workspaces\"\r\n| where resourceGroup in ({ResourceGroup}) or '*' in ({ResourceGroup})\r\n| extend \r\n    SKU = sku.name,\r\n    RetentionInDays = properties.retentionInDays,\r\n    ProvisioningState = properties.provisioningState,\r\n    PublicNetworkAccess = properties.publicNetworkAccessForIngestion\r\n| project \r\n    WorkspaceName = name,\r\n    ResourceGroup = resourceGroup,\r\n    Location = location,\r\n    SKU,\r\n    RetentionInDays,\r\n    WorkspaceId = properties.customerId,\r\n    PublicNetworkAccess,\r\n    ProvisioningState,\r\n    ResourceId = id\r\n| order by tostring(WorkspaceName) asc",
              "size": 0,
              "title": "Log Analytics Workspaces",
              "queryType": 1,
              "resourceType": "microsoft.resourcegraph/resources",
              "crossComponentResources": [
                "{Subscription}"
              ]
            },
            "name": "query - log analytics"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "Resources\r\n| where type == \"microsoft.insights/components\"\r\n| where resourceGroup in ({ResourceGroup}) or '*' in ({ResourceGroup})\r\n| extend \r\n    ApplicationType = properties.Application_Type,\r\n    IngestionMode = properties.IngestionMode,\r\n    WorkspaceResourceId = properties.WorkspaceResourceId,\r\n    RetentionInDays = properties.RetentionInDays,\r\n    PublicNetworkAccess = properties.publicNetworkAccessForIngestion\r\n| extend \r\n    WorkspaceName = split(WorkspaceResourceId, '/')[-1]\r\n| project \r\n    AppInsightsName = name,\r\n    ResourceGroup = resourceGroup,\r\n    Location = location,\r\n    ApplicationType,\r\n    InstrumentationKey = properties.InstrumentationKey,\r\n    ConnectionString = properties.ConnectionString,\r\n    LinkedWorkspace = coalesce(WorkspaceName, \"N/A\"),\r\n    RetentionInDays,\r\n    PublicNetworkAccess,\r\n    ResourceId = id\r\n| order by tostring(AppInsightsName) asc",
              "size": 0,
              "title": "Application Insights",
              "queryType": 1,
              "resourceType": "microsoft.resourcegraph/resources",
              "crossComponentResources": [
                "{Subscription}"
              ]
            },
            "name": "query - app insights"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "Resources\r\n| where resourceGroup in ({ResourceGroup}) or '*' in ({ResourceGroup})\r\n| where type in (\r\n    \"microsoft.compute/virtualmachines\",\r\n    \"microsoft.web/sites\",\r\n    \"microsoft.sql/servers\",\r\n    \"microsoft.storage/storageaccounts\",\r\n    \"microsoft.keyvault/vaults\",\r\n    \"microsoft.network/applicationgateways\",\r\n    \"microsoft.network/loadbalancers\"\r\n)\r\n| project ResourceName = name, ResourceType = type, ResourceId = id, ResourceGroup = resourceGroup\r\n| join kind=leftouter (\r\n    Resources\r\n    | where type == \"microsoft.insights/diagnosticsettings\"\r\n    | extend TargetResourceId = tostring(split(id, '/providers/microsoft.insights/diagnosticsettings')[0])\r\n    | extend \r\n        WorkspaceId = properties.workspaceId,\r\n        StorageAccountId = properties.storageAccountId,\r\n        EventHubAuthorizationRuleId = properties.eventHubAuthorizationRuleId\r\n    | extend \r\n        WorkspaceName = split(WorkspaceId, '/')[-1],\r\n        StorageAccountName = split(StorageAccountId, '/')[-1],\r\n        EventHubName = split(EventHubAuthorizationRuleId, '/')[-3]\r\n    | project TargetResourceId, DiagnosticSettingName = name, WorkspaceName, StorageAccountName, EventHubName\r\n) on $left.ResourceId == $right.TargetResourceId\r\n| project \r\n    ResourceName,\r\n    ResourceType,\r\n    ResourceGroup,\r\n    DiagnosticSetting = coalesce(DiagnosticSettingName, \"None\"),\r\n    LogAnalyticsWorkspace = coalesce(WorkspaceName, \"N/A\"),\r\n    StorageAccount = coalesce(StorageAccountName, \"N/A\"),\r\n    EventHub = coalesce(EventHubName, \"N/A\")\r\n| order by tostring(ResourceName) asc",
              "size": 0,
              "title": "Diagnostic Settings",
              "queryType": 1,
              "resourceType": "microsoft.resourcegraph/resources",
              "crossComponentResources": [
                "{Subscription}"
              ]
            },
            "name": "query - diagnostic settings"
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "selectedTab",
        "comparison": "isEqualTo",
        "value": "Monitoring"
      },
      "name": "group - monitoring"
    }
  ],
  "defaultResourceIds": [],
  "fallbackResourceIds": [],
  "$schema": "https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json"
}
